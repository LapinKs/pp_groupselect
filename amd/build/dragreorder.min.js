define("qtype_ddingroups/dragreorder",["exports","jquery","core/dragdrop","core/templates","core/notification","core/str","core/prefetch"],(function(_exports,_jquery,_dragdrop,_templates,_notification,_str,_prefetch){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_dragdrop=_interopRequireDefault(_dragdrop),_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification);class DragReorder{constructor(config){_defineProperty(this,"config",{reorderStart:void 0,reorderEnd:void 0}),_defineProperty(this,"dragStart",null),_defineProperty(this,"originalOrder",null),_defineProperty(this,"orderList",null),_defineProperty(this,"itemDragging",null),_defineProperty(this,"proxy",null),this.config=config,this.sourceContainer=null,this.orderList=document.querySelector(this.config.list),this.startListeners()}startListeners(){const pointerHandle=e=>{if(e.target.closest(this.config.item)&&!e.target.closest(this.config.actionButton)){this.itemDragging=(0,_jquery.default)(e.target.closest(this.config.item));const details=_dragdrop.default.prepare(e);details.start&&this.startDrag(e,details)}};this.orderList.addEventListener("mousedown",pointerHandle),this.orderList.addEventListener("touchstart",pointerHandle),this.orderList.addEventListener("click",this.itemMovedByClick.bind(this))}startDrag(e,details){this.dragStart={time:(new Date).getTime(),x:details.x,y:details.y},this.sourceContainer=this.itemDragging.closest(".sortablelist"),void 0!==this.config.reorderStart&&this.config.reorderStart(this.sourceContainer,this.itemDragging),this.originalOrder=this.getCurrentOrder(),_templates.default.renderForPromise("qtype_ddingroups/proxyhtml",{itemHtml:this.itemDragging.html(),itemClassName:this.itemDragging.attr("class"),listClassName:this.orderList.classList.toString(),proxyStyles:["width: ".concat(this.itemDragging.outerWidth(),"px;"),"height: ".concat(this.itemDragging.outerHeight(),"px;")].join(" ")}).then((_ref=>{let{html:html,js:js}=_ref;this.proxy=(0,_jquery.default)(_templates.default.appendNodeContents(document.body,html,js)[0]),this.proxy.css(this.itemDragging.offset()),this.itemDragging.addClass(this.config.itemMovingClass),this.updateProxy(),_dragdrop.default.start(e,this.proxy,this.dragMove.bind(this),this.dragEnd.bind(this))})).catch(_notification.default.exception)}dragMove(){let targetGroup=null;document.querySelectorAll(".sortablelist").forEach((container=>{const rect=container.getBoundingClientRect(),proxyRect=this.proxy[0].getBoundingClientRect();proxyRect.left>rect.left&&proxyRect.right<rect.right&&proxyRect.top>rect.top&&proxyRect.bottom<rect.bottom&&(targetGroup=container)})),this.targetGroup=targetGroup}updateProxy(){const items=[...this.orderList.querySelectorAll(this.config.item)];for(let i=0;i<items.length;++i)if(this.itemDragging[0]===items[i]){this.proxy.find("li").attr("value",i+1);break}}dragEnd(){if(void 0!==this.config.reorderEnd&&this.config.reorderEnd(this.itemDragging.closest(this.config.list),this.itemDragging),this.targetGroup){const groupList=this.targetGroup.querySelector(".group-answers");groupList.contains(this.itemDragging[0])||groupList.appendChild(this.itemDragging[0])}else this.sourceContainer.append(this.itemDragging[0]);if(!this.arrayEquals(this.originalOrder,this.getCurrentOrder())){var _this$itemDragging$cl;const currentGroup=(null===(_this$itemDragging$cl=this.itemDragging.closest(".group-box"))||void 0===_this$itemDragging$cl?void 0:_this$itemDragging$cl.id)||"general-box",newOrder=this.getCurrentOrder().map((itemId=>({id:itemId,group:currentGroup})));this.config.reorderDone(this.sourceContainer,this.itemDragging,newOrder),(0,_str.getString)("moved","qtype_ddingroups",{item:this.itemDragging.find("[data-itemcontent]").text().trim(),position:this.itemDragging.index()+1,total:this.orderList.querySelectorAll(this.config.item).length}).then((str=>{this.config.announcementRegion.innerHTML=str}))}this.proxy.remove(),this.proxy=null,this.itemDragging.removeClass(this.config.itemMovingClass),this.itemDragging=null,this.dragStart=null,this.targetGroup=null}midX(node){return node.offset().left+node.outerWidth()/2}midY(node){return node.offset().top+node.outerHeight()/2}distanceBetweenElements(element){const[e1,e2]=[(0,_jquery.default)(element),(0,_jquery.default)(this.proxy)],[dx,dy]=[this.midX(e1)-this.midX(e2),this.midY(e1)-this.midY(e2)];return Math.sqrt(dx*dx+dy*dy)}getCurrentOrder(){return this.itemDragging.closest(this.config.list).find(this.config.item).map(((index,item)=>this.config.idGetter(item))).get()}arrayEquals(a1,a2){return a1.length===a2.length&&a1.every(((v,i)=>v===a2[i]))}static init(config){const lists=config.lists,responseid=config.responseid;lists.forEach((list=>{new DragReorder({actionButton:"[data-action]",announcementRegion:document.querySelector("#".concat(list,"-announcement")),list:"ul#".concat(list),item:"li.sortableitem",itemMovingClass:"current-drop",idGetter:item=>item.id,reorderDone:(list,item,newOrder)=>{const response={};document.querySelectorAll(".group-box, #general-box").forEach((container=>{const groupId=container.id;response[groupId]=Array.from(container.querySelectorAll("li.sortableitem")).map((item=>item.id))})),(0,_jquery.default)("input#"+responseid)[0].value=JSON.stringify(response)}})})),(0,_prefetch.prefetchString)("qtype_ddingroups","moved")}}return _exports.default=DragReorder,_exports.default}));

//# sourceMappingURL=dragreorder.min.js.map