{"version":3,"file":"dragreorder.min.js","sources":["../src/dragreorder.js"],"sourcesContent":["'use strict';\nimport $ from 'jquery';\nimport drag from 'core/dragdrop';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\nimport {getString} from 'core/str';\nimport {prefetchString} from 'core/prefetch';\nexport default class DragReorder {\n\n    // Class variables handling state.\n    config = {reorderStart: undefined, reorderEnd: undefined}; // Config object with some basic definitions.\n    dragStart = null; // Information about when and where the drag started.\n    originalOrder = null; // Array of ids that's used to compare the state after the drag event finishes.\n\n    // DOM Nodes and jQuery representations.\n    orderList = null; // Order list (HTMLElement).\n    itemDragging = null; // Item being moved by dragging (jQuery object).\n    proxy = null; // Drag proxy (jQuery object).\n\n\n    constructor(config) {\n        // Bring in the config to our state.\n        this.config = config;\n        this.sourceContainer = null;\n        // Get the list we'll be working with this time.\n        this.orderList = document.querySelector(this.config.list);\n\n        this.startListeners();\n    }\n\n    /**\n     * Start the listeners for the list.\n     */\n    startListeners() {\n        /**\n         * Handle mousedown or touchstart events on the list.\n         *\n         * @param {Event} e The event.\n         */\n        const pointerHandle = e => {\n            if (e.target.closest(this.config.item) && !e.target.closest(this.config.actionButton)) {\n                this.itemDragging = $(e.target.closest(this.config.item));\n                const details = drag.prepare(e);\n                if (details.start) {\n                    this.startDrag(e, details);\n                }\n            }\n        };\n        // Set up the list listeners for moving list items around.\n        this.orderList.addEventListener('mousedown', pointerHandle);\n        this.orderList.addEventListener('touchstart', pointerHandle);\n        this.orderList.addEventListener('click', this.itemMovedByClick.bind(this));\n    }\n\n    /**\n     * Start dragging.\n     *\n     * @param {Event} e The event which is either mousedown or touchstart.\n     * @param {Object} details Object with start (boolean flag) and x, y (only if flag true) values\n     */\n    startDrag(e, details) {\n        this.dragStart = {\n            time: new Date().getTime(),\n            x: details.x,\n            y: details.y\n        };\n\n        this.sourceContainer = this.itemDragging.closest('.sortablelist'); // Сохраняем исходный контейнер.\n\n        if (typeof this.config.reorderStart !== 'undefined') {\n            this.config.reorderStart(this.sourceContainer, this.itemDragging);\n        }\n\n        this.originalOrder = this.getCurrentOrder();\n\n        Templates.renderForPromise('qtype_ddingroups/proxyhtml', {\n            itemHtml: this.itemDragging.html(),\n            itemClassName: this.itemDragging.attr('class'),\n            listClassName: this.orderList.classList.toString(),\n            proxyStyles: [\n                `width: ${this.itemDragging.outerWidth()}px;`,\n                `height: ${this.itemDragging.outerHeight()}px;`,\n            ].join(' '),\n        }).then(({html, js}) => {\n            this.proxy = $(Templates.appendNodeContents(document.body, html, js)[0]);\n            this.proxy.css(this.itemDragging.offset());\n\n            this.itemDragging.addClass(this.config.itemMovingClass);\n\n            this.updateProxy();\n            drag.start(e, this.proxy, this.dragMove.bind(this), this.dragEnd.bind(this));\n        }).catch(Notification.exception);\n    }\n\n\n    /**\n     * Move the proxy to the current mouse position.\n     */\n    dragMove() {\n        let closestItem = null;\n        let closestDistance = null;\n        let currentGroup = null;\n\n        // Определяем ближайший элемент в списке.\n        this.orderList.querySelectorAll(this.config.item).forEach(element => {\n            const distance = this.distanceBetweenElements(element);\n            if (closestItem === null || distance < closestDistance) {\n                closestItem = $(element);\n                closestDistance = distance;\n            }\n        });\n\n        // Определяем группу, над которой находится элемент.\n        document.querySelectorAll('.sortablelist').forEach(container => {\n            const rect = container.getBoundingClientRect();\n            if (\n                this.proxy.offset().left > rect.left &&\n                this.proxy.offset().right < rect.right &&\n                this.proxy.offset().top > rect.top &&\n                this.proxy.offset().bottom < rect.bottom\n            ) {\n                currentGroup = container;\n            }\n        });\n\n        if (currentGroup) {\n            const groupList = currentGroup.querySelector('.sortablelist');\n            if (!groupList.contains(this.itemDragging[0])) {\n                groupList.appendChild(this.itemDragging[0]);\n            }\n        } else if (closestItem && closestItem[0] !== this.itemDragging[0]) {\n            const offsetValue = this.midY(this.proxy) < this.midY(closestItem) ? 20 : -20;\n            if (this.midY(this.proxy) + offsetValue < this.midY(closestItem)) {\n                this.itemDragging.insertBefore(closestItem);\n            } else {\n                this.itemDragging.insertAfter(closestItem);\n            }\n        }\n\n        this.updateProxy();\n    }\n\n    /**\n     * Update proxy's position.\n     */\n    updateProxy() {\n        const items = [...this.orderList.querySelectorAll(this.config.item)];\n        for (let i = 0; i < items.length; ++i) {\n            if (this.itemDragging[0] === items[i]) {\n                this.proxy.find('li').attr('value', i + 1);\n                break;\n            }\n        }\n    }\n    dragEnd() {\n        if (typeof this.config.reorderEnd !== 'undefined') {\n            this.config.reorderEnd(this.itemDragging.closest(this.config.list), this.itemDragging);\n        }\n\n        // Если элемент не находится в допустимой зоне, возвращаем его в исходный контейнер.\n        if (!this.itemDragging.closest('.sortablelist')) {\n            this.sourceContainer.append(this.itemDragging[0]);\n        }\n\n        if (!this.arrayEquals(this.originalOrder, this.getCurrentOrder())) {\n            const currentGroup = this.itemDragging.closest('.group-box')?.id || 'general-box';\n            const newOrder = this.getCurrentOrder().map(itemId => ({\n                id: itemId,\n                group: currentGroup,\n            }));\n            this.config.reorderDone(this.itemDragging.closest(this.config.list), this.itemDragging, newOrder);\n            getString('moved', 'qtype_ddingroups', {\n                item: this.itemDragging.find('[data-itemcontent]').text().trim(),\n                position: this.itemDragging.index() + 1,\n                total: this.orderList.querySelectorAll(this.config.item).length\n            }).then((str) => {\n                this.config.announcementRegion.innerHTML = str;\n            });\n        }\n\n        this.proxy.remove();\n        this.proxy = null;\n        this.itemDragging.removeClass(this.config.itemMovingClass);\n        this.itemDragging = null;\n        this.dragStart = null;\n    }\n    midX(node) {\n        return node.offset().left + node.outerWidth() / 2;\n    }\n    midY(node) {\n        return node.offset().top + node.outerHeight() / 2;\n    }\n    distanceBetweenElements(element) {\n        const [e1, e2] = [$(element), $(this.proxy)];\n        const [dx, dy] = [this.midX(e1) - this.midX(e2), this.midY(e1) - this.midY(e2)];\n        return Math.sqrt(dx * dx + dy * dy);\n    }\n    getCurrentOrder() {\n        return this.itemDragging.closest(this.config.list).find(this.config.item).map(\n            (index, item) => {\n                return this.config.idGetter(item);\n            }).get();\n    }\n    arrayEquals(a1, a2) {\n        return a1.length === a2.length &&\n            a1.every((v, i) => {\n                return v === a2[i];\n            }); }\n    static init(config) {\n        const lists = config.lists;\n        const responseid = config.responseid;\n        lists.forEach(list => {\n            new DragReorder({\n                actionButton: '[data-action]',\n                announcementRegion: document.querySelector(`#${list}-announcement`),\n                list: `ul#${list}`,\n                item: 'li.sortableitem',\n                itemMovingClass: \"current-drop\",\n                idGetter: item => {\n                    return item.id;\n                },\n// eslint-disable-next-line no-unused-vars\n                reorderDone: (list, item, newOrder) => {\n                    const response = {};\n                    document.querySelectorAll('.group-box, #general-box').forEach(container => {\n                        const groupId = container.id;\n                        response[groupId] = Array.from(container.querySelectorAll('li.sortableitem')).map(item => item.id);\n                    });\n\n                    $('input#' + responseid)[0].value = JSON.stringify(response);\n                }\n            });\n        });\n        prefetchString('qtype_ddingroups', 'moved');\n    }\n}\n"],"names":["DragReorder","constructor","config","reorderStart","undefined","reorderEnd","sourceContainer","orderList","document","querySelector","this","list","startListeners","pointerHandle","e","target","closest","item","actionButton","itemDragging","details","drag","prepare","start","startDrag","addEventListener","itemMovedByClick","bind","dragStart","time","Date","getTime","x","y","originalOrder","getCurrentOrder","renderForPromise","itemHtml","html","itemClassName","attr","listClassName","classList","toString","proxyStyles","outerWidth","outerHeight","join","then","_ref","js","proxy","Templates","appendNodeContents","body","css","offset","addClass","itemMovingClass","updateProxy","dragMove","dragEnd","catch","Notification","exception","closestItem","closestDistance","currentGroup","querySelectorAll","forEach","element","distance","distanceBetweenElements","container","rect","getBoundingClientRect","left","right","top","bottom","groupList","contains","appendChild","offsetValue","midY","insertBefore","insertAfter","items","i","length","find","append","arrayEquals","id","newOrder","map","itemId","group","reorderDone","text","trim","position","index","total","str","announcementRegion","innerHTML","remove","removeClass","midX","node","e1","e2","dx","dy","Math","sqrt","idGetter","get","a1","a2","every","v","lists","responseid","response","groupId","Array","from","value","JSON","stringify"],"mappings":"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"}